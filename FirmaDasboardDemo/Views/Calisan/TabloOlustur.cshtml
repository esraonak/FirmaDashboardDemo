@{
    ViewData["Title"] = "Tablo Oluştur";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h3>Yeni Hesaplama Tablosu</h3>

<!-- Ürün Seç -->
<div class="form-group">
    <label>Ürün Seç</label>
    <select id="urunSec" class="form-control">
        @foreach (var urun in ViewBag.Urunler)
        {
            <option value="@urun.Id">@urun.Ad</option>
        }
    </select>
</div>

<!-- Tablo Adı -->
<div class="form-group">
    <label>Tablo Adı</label>
    <input id="tabloAdi" class="form-control" placeholder="Örn: Fiyat Tablosu" />
</div>

<!-- Açıklama -->
<div class="form-group">
    <label>Açıklama</label>
    <textarea id="aciklama" class="form-control" placeholder="İsteğe bağlı açıklama"></textarea>
</div>

<!-- Tablo Alanı -->
<div id="tablo" style="margin-top: 20px;"></div>

<!-- Kaydet Butonu -->
<button class="btn btn-primary mt-3" onclick="kaydet()">Kaydet</button>

<!-- Stil Sorununu Çözmek için -->
<style>
    .jss_toolbar {
        white-space: nowrap;
        overflow-x: auto;
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
    }

        .jss_toolbar > div {
            margin-right: 5px;
        }
</style>

<!-- Gerekli Kütüphaneler (CDN) -->
<script src="https://bossanova.uk/jspreadsheet/v5/jspreadsheet.js"></script>
<script src="https://jsuites.net/v5/jsuites.js"></script>
<link rel="stylesheet" href="https://bossanova.uk/jspreadsheet/v5/jspreadsheet.css" type="text/css" />
<link rel="stylesheet" href="https://jsuites.net/v5/jsuites.css" type="text/css" />

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Material+Icons" />
<script>
    let tablo;

    document.addEventListener("DOMContentLoaded", function () {
        tablo = jspreadsheet(document.getElementById('tablo'), {
            parseFormulas: true,
            worksheets: [{
                worksheetName: 'Hesap',
                minDimensions: [3, 3],
                columns: [
                    { type: 'text', title: 'A', width: 100 },
                    { type: 'text', title: 'B', width: 100 },
                    { type: 'text', title: 'C', width: 100 }
                ],
                data: [
                    ["=1+2", "=A1+5", ""],
                    ["", "=A2+10", ""]
                ]
            }]
        });
    });

            function kaydet() {
        const urunId = document.getElementById('urunSec').value;
        const tabloAdi = document.getElementById('tabloAdi').value;
        const aciklama = document.getElementById('aciklama').value;

        // 🧠 Orijinal veri (formüller dahil)
        const rawData = tablo.options.data;

        const hucreler = [];

        for (let i = 0; i < rawData.length; i++) {
            const row = rawData[i];
            for (let j = 0; j < row.length; j++) {
                const cell = row[j];
                hucreler.push({
                    HucreAdi: String.fromCharCode(65 + j) + (i + 1), // Örn: B2
                    Formul: cell ?? "", // null ya da undefined olursa boş string
                    IsFormul: typeof cell === "string" && cell.trim().startsWith("=")
                });
            }
        }

         function kaydet() {
        const rawTableData = tablo.getData(false); // raw (formül) verisi
        const processedTableData = tablo.getData(); // varsayılan: hesaplanan değerler

        const hucreler = [];

        rawTableData.forEach((row, i) => {
            row.forEach((cellRaw, j) => {
                const cellName = String.fromCharCode(65 + j) + (i + 1);
                hucreler.push({
                    HucreAdi: cellName,
                    Formul: cellRaw,
                    IsFormul: typeof cellRaw === 'string' && cellRaw.trim().startsWith("=")
                });
            });
        });

        fetch('/api/tablo/kaydet', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({
                UrunId: parseInt(document.getElementById('urunSec').value),
                TabloAdi: document.getElementById('tabloAdi').value,
                Aciklama: document.getElementById('aciklama').value,
                Hucreler: hucreler
            })
        })
        .then(res => res.json())
        .then(res => alert("Tablo başarıyla kaydedildi!"));
    }

    }
</script>

