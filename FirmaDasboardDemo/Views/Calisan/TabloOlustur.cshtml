@{
    ViewData["Title"] = "Tablo Oluştur";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h3>Yeni Hesaplama Tablosu (Handsontable)</h3>

<div id="hot" style="margin-top: 20px; width: 100%;"></div>

<button class="btn btn-primary mt-3" onclick="kaydet()">Kaydet</button>

<!-- Stil -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@13.0.0/dist/handsontable.full.min.css" />

<!-- Script -->
<script src="https://cdn.jsdelivr.net/npm/hyperformula@1.5.0/dist/hyperformula.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/handsontable@13.0.0/dist/handsontable.full.min.js"></script>

<script>
    let hot;

    document.addEventListener("DOMContentLoaded", function () {
        const container = document.getElementById('hot');

        hot = new Handsontable(container, {
            data: [
                ['=1+2', '=A1*3', ''],
                ['', '=A2+5', '']
            ],
            rowHeaders: true,
            colHeaders: ['A', 'B', 'C'],
            formulas: {
                engine: HyperFormula
            },
            licenseKey: 'non-commercial-and-evaluation' // Ücretsiz kullanım
        });
    });

    function kaydet() {
        const formulluVeri = hot.getSourceData(); // =A1+1 gibi formülleri alır

        const hucreler = [];

        formulluVeri.forEach((row, i) => {
            row.forEach((value, j) => {
                hucreler.push({
                    HucreAdi: String.fromCharCode(65 + j) + (i + 1),
                    Formul: value,
                    IsFormul: typeof value === 'string' && value.trim().startsWith("=")
                });
            });
        });

        fetch('/api/tablo/kaydet', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                UrunId: 0, // Gerekirse seçilebilir alanla değiştirirsin
                TabloAdi: "Otomatik Tablo",
                Aciklama: "Handsontable üzerinden geldi.",
                Hucreler: hucreler
            })
        }).then(res => res.json())
          .then(res => alert("✅ Tablo başarıyla kaydedildi!"));
    }
</script>
