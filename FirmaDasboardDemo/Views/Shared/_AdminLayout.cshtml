@{
    Layout = null;
    var seo = Context.Session.GetString("FirmaSeoUrl");
    ViewBag.FirmaSosyalMedya = new
    {
        Instagram = "https://instagram.com/tentecrm",
        Twitter = "https://twitter.com/tentecrm",
        Facebook = "https://facebook.com/tentecrm",
        Website = "https://www.tentecrm.com.tr"
    };
}

<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - FirmaDashboard</title>

    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700" rel="stylesheet" />
    <link rel="stylesheet" href="~/plugins/fontawesome-free/css/all.min.css" />
    <link rel="stylesheet" href="~/dist/css/adminlte.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />

    <!-- DataTables Bootstrap 4 + Responsive (CSS) -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap4.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap4.min.css" />

    <!-- Toastr -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet" />

    @RenderSection("Styles", required: false)

    <style>
        .kapali-ticket {
            background-color: #f2f2f2;
            color: #999;
            opacity: 0.6;
        }

            .kapali-ticket td {
                pointer-events: auto;
            }

            .kapali-ticket .btn,
            .kapali-ticket a {
                pointer-events: auto !important;
                opacity: 0.8 !important;
            }
    </style>
</head>

<body class="hold-transition sidebar-mini layout-fixed">
    <div class="wrapper">
        <!-- Navbar -->
        <nav class="main-header navbar navbar-expand navbar-white navbar-light">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" data-widget="pushmenu" href="#"><i class="fas fa-bars"></i></a>
                </li>
            </ul>

            <ul class="navbar-nav ml-auto">
                <!-- Bildirim Dropdown -->
                <li class="nav-item dropdown" id="bildirimDropdown">
                    <a class="nav-link" href="#" role="button" data-toggle="dropdown">
                        <i class="fas fa-bell"></i>
                        <span id="bildirimSayisi" class="badge badge-danger navbar-badge d-none">0</span>
                    </a>
                    <div id="bildirimMenu" class="dropdown-menu dropdown-menu-right shadow animated--grow-in">
                        <span class="dropdown-header">Yükleniyor...</span>
                    </div>
                </li>
            </ul>
        </nav>

        <!-- Sidebar -->
        <aside class="main-sidebar sidebar-dark-primary elevation-4">
            <a href="#" class="brand-link d-flex align-items-center">
                @if (!string.IsNullOrEmpty(ViewBag.FirmaLogo))
                {
                    <img src="@ViewBag.FirmaLogo" alt="Logo"
                         class="brand-image img-circle elevation-3 ml-2 img-fluid"
                         style="opacity:.9; max-height:35px; object-fit:contain;" />
                }
                else
                {
                    <i class="fas fa-cogs ml-3 mr-2"></i>
                }
                <span class="brand-text font-weight-bold ml-2">@($"{seo?.ToUpper()} ADMIN PANELİ")</span>
            </a>
            <div class="sidebar">
                <nav class="mt-2">
                    <ul class="nav nav-pills nav-sidebar flex-column">
                        <li class="nav-item"><a href="/@seo/Admin/Bayi/BayiList" class="nav-link"><i class="nav-icon fas fa-users"></i><p>Bayiler</p></a></li>
                        <li class="nav-item"><a href="/@seo/Admin/Calisan/Calisanlar" class="nav-link"><i class="nav-icon fas fa-user-shield"></i><p>Admin Yetkilileri</p></a></li>
                        <li class="nav-item"><a href="/@seo/Admin/Degisken/FirmaDegiskenleri" class="nav-link"><i class="nav-icon fas fa-cog"></i><p>Firma Değişkenleri</p></a></li>
                        <li class="nav-item"><a href="/@seo/Admin/Tablo/TabloOlustur" class="nav-link"><i class="nav-icon fas fa-table"></i><p>Tablo Oluştur</p></a></li>
                        <li class="nav-item"><a href="/@seo/Admin/Tablo/TabloDuzenle" class="nav-link"><i class="nav-icon fas fa-edit"></i><p>Tablo Düzenle</p></a></li>
                        <li class="nav-item"><a href="/@seo/Admin/Tablo/TabloSil" class="nav-link"><i class="nav-icon fas fa-trash-alt"></i><p>Tablo Sil</p></a></li>
                        <li class="nav-item"><a href="/@seo/Admin/Bayi/Mesajlar" class="nav-link"><i class="nav-icon fas fa-envelope"></i><p>Bayi Mesajları</p></a></li>
                        <li class="nav-item"><a href="/@seo/Admin/KullaniciAyar" class="nav-link"><i class="nav-icon fas fa-user-cog"></i><p>Kullanıcı Ayarları</p></a></li>
                        <li class="nav-item"><a href="/@seo/Admin/Login" class="nav-link"><i class="nav-icon fas fa-sign-out-alt"></i><p>Çıkış Yap</p></a></li>
                    </ul>
                </nav>
            </div>
        </aside>

        <!-- İçerik -->
        <div class="content-wrapper">
            <div class="content-header">
                <div class="container-fluid">
                    <h1 class="m-0">@ViewData["Title"]</h1>
                </div>
            </div>
            <section class="content">
                <div class="container-fluid">
                    @RenderBody()
                </div>
            </section>
        </div>

        <footer class="main-footer text-sm d-flex justify-content-between align-items-center px-3 py-2">
            <div>
                <strong>&copy; 2025 FirmaDashboard</strong> Tüm hakları saklıdır. <span class="ml-2">v1.0</span>
            </div>

            <div>
                @if (ViewBag.FirmaSosyalMedya != null)
                {
                    dynamic sosyal = ViewBag.FirmaSosyalMedya;

                    if (!string.IsNullOrEmpty(sosyal.Instagram) && sosyal.Instagram != "#")
                    {
                        <a href="@sosyal.Instagram" target="_blank" class="text-danger mx-2" title="Instagram">
                            <i class="fab fa-instagram fa-lg"></i>
                        </a>
                    }
                    if (!string.IsNullOrEmpty(sosyal.Twitter) && sosyal.Twitter != "#")
                    {
                        <a href="@sosyal.Twitter" target="_blank" class="text-info mx-2" title="Twitter">
                            <i class="fab fa-twitter fa-lg"></i>
                        </a>
                    }
                    if (!string.IsNullOrEmpty(sosyal.Facebook) && sosyal.Facebook != "#")
                    {
                        <a href="@sosyal.Facebook" target="_blank" class="text-primary mx-2" title="Facebook">
                            <i class="fab fa-facebook fa-lg"></i>
                        </a>
                    }
                    if (!string.IsNullOrEmpty(sosyal.Website) && sosyal.Website != "#")
                    {
                        <a href="@sosyal.Website" target="_blank" class="text-success mx-2" title="Web Sitesi">
                            <i class="fas fa-globe fa-lg"></i>
                        </a>
                    }
                }
            </div>
        </footer>
    </div>

    <!-- JS: jQuery → Bootstrap → AdminLTE → Eklentiler -->
    <script src="~/plugins/jquery/jquery.min.js"></script>
    <script src="~/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="~/dist/js/adminlte.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

    <!-- DataTables core + Bootstrap4 + Responsive (JS) -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap4.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap4.min.js"></script>

    <!-- Bildirimleri getir -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const seo = "@(seo ?? "")";
            const dropdown = document.getElementById("bildirimDropdown");
            const badge = document.getElementById("bildirimSayisi");
            const menu = document.getElementById("bildirimMenu");

            function bildirimiYukle() {
                if (!seo) { return; }
                fetch(`/${seo}/Admin/GetOkunmamisMesajSayisi`)
                    .then(res => {
                        if (!res.ok) throw new Error("Sunucu hatası");
                        return res.json();
                    })
                    .then(data => {
                        menu.innerHTML = "";

                        if (!Array.isArray(data) || data.length === 0) {
                            badge.classList.add("d-none");
                            menu.innerHTML = `<span class="dropdown-item text-muted">Yeni mesaj yok</span>`;
                            return;
                        }

                        badge.textContent = data.length;
                        badge.classList.remove("d-none");

                        menu.innerHTML += `<span class="dropdown-header">${data.length} yeni mesaj</span><div class="dropdown-divider"></div>`;
                        data.forEach(bayi => {
                            menu.innerHTML += `
                                <a href="/${seo}/Admin/Bayi/Mesajlar?bayiId=${bayi.id}" class="dropdown-item d-flex align-items-center">
                                    <i class="fas fa-user text-primary mr-2"></i>
                                    <span><strong>${bayi.ad}</strong> yeni mesaj gönderdi</span>
                                </a>`;
                        });
                    })
                    .catch(err => {
                        console.error("Bildirim hatası:", err);
                        badge.classList.add("d-none");
                        menu.innerHTML = `<span class="dropdown-item text-danger">Bildirim yüklenemedi</span>`;
                    });
            }

            if (seo) {
                fetch(`/${seo}/Admin/GetOkunmamisMesajSayisi`)
                    .then(res => res.json())
                    .then(data => {
                        if (Array.isArray(data) && data.length > 0) {
                            badge.textContent = data.length;
                            badge.classList.remove("d-none");
                        } else {
                            badge.classList.add("d-none");
                        }
                    })
                    .catch(() => {
                        badge.classList.add("d-none");
                    });
            }

            if (dropdown) {
                dropdown.addEventListener("mouseenter", bildirimiYukle);
                dropdown.addEventListener("click", function (e) {
                    e.preventDefault();
                    bildirimiYukle();
                });
                dropdown.addEventListener("touchstart", function () { bildirimiYukle(); }, { passive: true });
            }
        });

        function TicketKapat(id) {
            const seo = "@(seo ?? "")";
            if (!seo) return;
            fetch(`/${seo}/Admin/Mesaj/Kapat/${id}`, { method: "POST" })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        if (window.toastr) toastr.success("Ticket kapatıldı.");
                        location.reload();
                    } else {
                        if (window.toastr) toastr.error("İşlem başarısız.");
                    }
                });
        }

        function MesajSil(id) {
            Swal.fire({
                title: "Silmek istediğinize emin misiniz?",
                icon: "warning",
                showCancelButton: true,
                confirmButtonText: "Evet, sil",
                cancelButtonText: "İptal"
            }).then((result) => {
                if (result.isConfirmed) {
                    const seo = "@(seo ?? "")";
                    if (!seo) return;
                    fetch(`/${seo}/Admin/Mesaj/Sil/${id}`, { method: "POST" })
                        .then(res => res.json())
                        .then(data => {
                            if (data.success) {
                                if (window.toastr) toastr.success("Mesaj başarıyla silindi.");
                                location.reload();
                            } else {
                                if (window.toastr) toastr.error("Silme işlemi başarısız.");
                            }
                        });
                }
            });
        }
    </script>

    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>
