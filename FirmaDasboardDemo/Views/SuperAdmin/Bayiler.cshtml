@{
    ViewData["Title"] = "Bayiler";
    Layout = "~/Views/Shared/_SuperAdminLayout.cshtml";
}

<div class="card">
    <div class="card-header">
        <h3 class="card-title">Bayi Listesi</h3>
    </div>
    <div class="card-body">
        <table id="bayiTablosu" class="table table-bordered table-striped">
            <thead>
                <tr>
                    <th>Ad Soyad</th>
                    <th>Email</th>
                    <th>Telefon</th>
                    <th>Firma</th>
                    <th>Aktif</th>
                    <th>İşlem</th>
                </tr>
            </thead>
        </table>
    </div>
</div>
<!-- ✅ Bayi Düzenle Modal buraya gelecek -->
<div class="modal fade" id="bayiDuzenleModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Bayi Düzenle</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="duzenleId">
                <div class="form-group">
                    <label>Ad</label>
                    <input type="text" id="duzenleAd" class="form-control" />
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="duzenleEmail" class="form-control" />
                </div>
                <div class="form-group">
                    <label>Telefon</label>
                    <input type="text" id="duzenleTelefon" class="form-control" />
                </div>
                <div class="form-group">
                    <label>Lisans Bitiş</label>
                    <input type="date" id="duzenleLisans" class="form-control" />
                </div>
                <div class="form-group form-check">
                    <input type="checkbox" id="duzenleAktif" class="form-check-input" />
                    <label class="form-check-label" for="duzenleAktif">Aktif Mi?</label>
                </div>


            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="bayiGuncelle()">Güncelle</button>
                <button class="btn btn-secondary" data-dismiss="modal">İptal</button>
            </div>
        </div>
    </div>
</div>
@section Scripts {
    <script>
        $(function () {
            $('#bayiTablosu').DataTable({
                ajax: {
                    url: '/SuperAdmin/GetBayiler',
                    dataSrc: ''
                },
                           columns: [
            { data: 'adSoyad' },
            { data: 'email' },
            { data: 'telefon' },
            {
                data: 'firmaAd',
                render: function (data) {
                    if (Array.isArray(data)) {
                        return data.join(", ");
                    }
                    return data || "-";
                }
            },
            {
              data: 'aktifMi',
                        render: data => data ? 'Evet' : 'Hayır'
            },
            {
                data: 'id',
                render: function (id) {
                    return `
                        <button class="btn btn-warning btn-sm" onclick="bayiDuzenle(${id})">Düzenle</button>
                        <button class="btn btn-danger btn-sm" onclick="bayiSil(${id})">Sil</button>
                    `;
                }
            }
        ]

            });
        });

        function bayiSil(id) {
            if (confirm("Bu bayiyi pasif hale getirmek istiyor musunuz?")) {
                $.post('/SuperAdmin/BayiSil', { id: id }, function (response) {
                    if (response.success) {
                        $('#bayiTablosu').DataTable().ajax.reload(); // tabloyu yenile
                    } else {
                        alert("İşlem başarısız.");
                    }
                });
            }
        }




                      function bayiDuzenle(id) {
            $.get('/SuperAdmin/BayiGetir', { id: id }, function (data) {
                $('#duzenleId').val(data.id);
                $('#duzenleAd').val(data.adSoyad);
                $('#duzenleEmail').val(data.email);
                $('#duzenleTelefon').val(data.telefon);

                // 🔍 Eğer tarih varsa input'a ata, yoksa boş bırak
                if (data.lisansBitis) {
                    $('#duzenleLisans').val(data.lisansBitis); // zaten yyyy-MM-dd formatında geliyor
                } else {
                    $('#duzenleLisans').val('');
                }

                $('#duzenleAktif').prop('checked', data.aktifMi);
                $('#bayiDuzenleModal').modal('show');
            });
        }


             function bayiGuncelle() {
            var id = $('#duzenleId').val();
            var lisansStr = $('#duzenleLisans').val();

            // 🚫 Lisans tarihi kontrolü
            if (!lisansStr || lisansStr === "0001-01-01") {
                toastr.error("Lisans bitiş tarihi geçerli değil. Lütfen geçerli bir tarih girin.");
                return;
            }

            var lisansDate = new Date(lisansStr);
            var bugun = new Date();
            bugun.setHours(0, 0, 0, 0); // sadece tarih karşılaştırması

            if (lisansDate < bugun) {
                toastr.error("Lisans bitiş tarihi geçmişte olamaz.");
                return;
            }

            var model = {
                id: id,
                adSoyad: $('#duzenleAd').val(),
                email: $('#duzenleEmail').val(),
                telefon: $('#duzenleTelefon').val(),
                lisansBitis: lisansStr,
                aktifMi: $('#duzenleAktif').is(':checked')
            };

            $.post('/SuperAdmin/BayiGuncelle', model, function (result) {
                if (result.success) {
                    toastr.success("Bayi başarıyla güncellendi.");
                    $('#bayiDuzenleModal').modal('hide');
                    $('#bayiTablosu').DataTable().ajax.reload();
                } else {
                    toastr.error(result.message || "Güncelleme başarısız.");
                }
            }).fail(function () {
                toastr.error("Sunucu hatası oluştu.");
            });
        }


    </script>
}

